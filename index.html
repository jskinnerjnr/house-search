<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wrong Move by Slim Charles & Co</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f4f0; color: #2c2c2c; -webkit-tap-highlight-color: transparent; }

  /* â”€â”€ HEADER â”€â”€ */
  header { background: #2c2c2c; color: white; display: flex; flex-direction: column; position: sticky; top: 0; z-index: 50; }
  .header-img-wrap { position: relative; }
  .header-img { width: 100%; height: 120px; object-fit: cover; object-position: center 55%; display: block; }
  .header-img-title { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: flex-end; padding: 12px 16px; background: linear-gradient(transparent 30%, rgba(0,0,0,0.6) 100%); }
  .header-img-title h1 { font-size: 1.4rem; font-weight: 800; color: white; text-shadow: 0 1px 4px rgba(0,0,0,0.5); letter-spacing: -0.01em; }
  .header-bar { padding: 8px 16px; display: flex; justify-content: space-between; align-items: center; gap: 8px; }
  header h1 { font-size: 1.1rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .header-right { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
  #last-updated { font-size: 0.78rem; opacity: 0.6; }
  #remote-updated { font-size: 0.7rem; opacity: 0.45; }
  .filter-toggle-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.82rem; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
  .filter-toggle-btn.active { background: white; color: #2c2c2c; }

  /* â”€â”€ FILTER DRAWER (mobile: slide-up sheet; desktop: horizontal bar) â”€â”€ */
  .filters-backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 60; }
  .filters-backdrop.open { display: block; }
  .filters {
    background: white;
    border-bottom: 1px solid #e0e0e0;
    display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end;
    padding: 16px;
  }
  .filter-group { display: flex; flex-direction: column; gap: 4px; }
  .filter-group label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #888; font-weight: 600; }
  .filter-group select, .filter-group input[type=number] { padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; background: white; min-width: 130px; }
  .filter-group input[type=range] { min-width: 150px; accent-color: #2c2c2c; }
  .price-display { font-size: 0.78rem; color: #555; margin-top: 2px; font-weight: 500; }
  .reset-btn { padding: 9px 18px; background: #2c2c2c; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; }
  .filters-close-btn { display: none; width: 100%; padding: 12px; background: #2c2c2c; color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 4px; }

  /* â”€â”€ STATS BAR â”€â”€ */
  .stats-bar { padding: 8px 16px; background: #f5f4f0; font-size: 0.8rem; color: #666; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }

  /* â”€â”€ GRID â”€â”€ */
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; padding: 12px; padding-bottom: 80px; }

  /* â”€â”€ CARDS â”€â”€ */
  .card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.08); transition: box-shadow 0.2s; cursor: pointer; }
  .card:active { transform: scale(0.99); }
  .card-img-wrap { position: relative; }
  .card-img { width: 100%; height: 200px; object-fit: cover; display: block; background: #f0f0f0; cursor: zoom-in; }
  .card-img-overlay { display: none; position: absolute; bottom: 0; left: 0; right: 0; padding: 28px 14px 10px; background: linear-gradient(transparent, rgba(0,0,0,0.72)); color: white; pointer-events: none; }
  .card-img-overlay .ov-address { font-weight: 700; font-size: 0.95rem; line-height: 1.3; }
  .card-img-overlay .ov-price { font-size: 1rem; font-weight: 700; margin-top: 2px; }
  .card-img-overlay .ov-price .price-reduced, .card-img-overlay .ov-price .new-listing { font-size: 0.65rem; }
  .card-img-placeholder { width: 100%; height: 160px; background: linear-gradient(135deg,#f0f0f0,#e0e0e0); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; font-size: 2rem; color: #aaa; }
  .card-thumb-strip { display: flex; gap: 4px; padding: 6px 8px; background: #fafafa; border-bottom: 1px solid #f0f0f0; overflow: hidden; }
  .card-thumb { width: 56px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer; opacity: 0.85; flex-shrink: 0; }
  .card-thumb:hover { opacity: 1; }
  .card-thumb-fp { width: 56px; height: 40px; object-fit: contain; border-radius: 4px; cursor: pointer; background: #f0f0f0; border: 1px solid #e0e0e0; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
  .card-thumb-more { width: 40px; height: 40px; background: #eee; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #888; font-weight: 600; flex-shrink: 0; cursor: pointer; }
  .card-img-placeholder span { font-size: 0.78rem; color: #888; text-decoration: underline; }
  .card-img-link { display: block; text-decoration: none; }
  .card-header { padding: 12px 14px 8px; border-bottom: 1px solid #f0f0f0; }
  .card-address { font-weight: 700; font-size: 0.95rem; }
  .card-location { font-size: 0.78rem; color: #777; margin-top: 2px; }
  .card-price { font-size: 1.15rem; font-weight: 700; color: #2c2c2c; margin-top: 6px; line-height: 1.4; }
  .price-reduced { font-size: 0.68rem; background: #ff6b35; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle; }
  .new-listing { font-size: 0.68rem; background: #1a7340; color: white; padding: 2px 6px; border-radius: 4px; margin-left: 6px; vertical-align: middle; font-weight: 700; }
  .card-body { padding: 10px 14px; display: flex; flex-direction: column; gap: 7px; }
  .specs { display: flex; gap: 10px; flex-wrap: wrap; }
  .spec { font-size: 0.8rem; color: #555; display: flex; align-items: center; gap: 3px; }
  .spec strong { color: #2c2c2c; }
  .tags { display: flex; gap: 5px; flex-wrap: wrap; }
  .tag { font-size: 0.7rem; padding: 2px 8px; border-radius: 12px; font-weight: 500; }
  .tag-yes { background: #e6f4ea; color: #2d7a3a; }
  .tag-neutral { background: #eee; color: #555; }
  .school-info { font-size: 0.76rem; color: #555; line-height: 1.5; }
  .school-info a { color: #888; }
  .ofsted-outstanding { color: #1a7340; font-weight: 600; }
  .ofsted-good { color: #2e7bb5; font-weight: 600; }
  .ofsted-ri { color: #c87000; font-weight: 600; }
  .card-footer { padding: 8px 14px; border-top: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 6px; }
  .status-badge { font-size: 0.68rem; padding: 3px 10px; border-radius: 12px; font-weight: 600; }
  .status-new { background: #e3f2fd; color: #1565c0; }
  .status-viewing { background: #fff8e1; color: #b8860b; }
  .status-viewed { background: #f3e5f5; color: #7b1fa2; }
  .status-interested { background: #e8f5e9; color: #2e7d32; }
  .status-offer { background: #fce4ec; color: #c62828; }
  .status-rejected { background: #eeeeee; color: #757575; }
  .rating { color: #f5a623; font-size: 0.9rem; }
  .links { display: flex; gap: 5px; flex-wrap: wrap; }
  .links a { font-size: 0.7rem; color: #2c2c2c; text-decoration: none; padding: 4px 10px; border: 1px solid #ddd; border-radius: 6px; }
  .links a.plan-btn { background: #2c2c2c; color: white; border-color: #2c2c2c; }
  .pros-cons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 0 14px 10px; }
  .pros h4, .cons h4 { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; }
  .pros h4 { color: #2d7a3a; }
  .cons h4 { color: #a33; }
  .pros ul, .cons ul { font-size: 0.76rem; color: #555; padding-left: 14px; }
  .notes-section { padding: 0 14px 10px; font-size: 0.76rem; color: #666; font-style: italic; }
  .empty-state { grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #aaa; }

  /* â”€â”€ FAB (add button) â”€â”€ */
  .add-btn { position: fixed; bottom: 20px; right: 16px; background: #2c2c2c; color: white; border: none; border-radius: 50%; width: 54px; height: 54px; font-size: 1.6rem; cursor: pointer; box-shadow: 0 4px 14px rgba(0,0,0,0.35); display: flex; align-items: center; justify-content: center; z-index: 40; }

  /* â”€â”€ DETAIL SHEET â”€â”€ */
  .ds-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.55); z-index:200; align-items:flex-end; }
  .ds-overlay.open { display:flex; }
  .ds-sheet { background:#f0eff0; border-radius:24px 24px 0 0; width:100%; max-height:94vh; overflow-y:auto; -webkit-overflow-scrolling:touch; padding-bottom:env(safe-area-inset-bottom,16px); }
  .ds-handle { width:40px; height:4px; background:#d0d0d0; border-radius:4px; margin:12px auto 0; }
  /* Photo carousel */
  .ds-carousel { display:flex; overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
  .ds-carousel::-webkit-scrollbar { display:none; }
  .ds-slide { flex-shrink:0; width:100%; scroll-snap-align:start; position:relative; }
  .ds-slide img { width:100%; height:260px; object-fit:cover; display:block; }
  .ds-slide-label { position:absolute; bottom:8px; left:10px; background:rgba(0,0,0,0.5); color:white; font-size:0.68rem; padding:2px 8px; border-radius:8px; }
  .ds-dots { display:flex; justify-content:center; gap:5px; padding:8px 0 4px; }
  .ds-dot { width:6px; height:6px; border-radius:50%; background:#ccc; transition:background 0.2s; }
  .ds-dot.active { background:#2c2c2c; }
  /* Hero price/address */
  .ds-hero { padding:14px 16px 10px; }
  .ds-price { font-size:1.6rem; font-weight:800; color:#2c2c2c; line-height:1.1; }
  .ds-address { font-size:1rem; font-weight:600; color:#2c2c2c; margin-top:4px; }
  .ds-location { font-size:0.82rem; color:#777; margin-top:2px; }
  /* Sections */
  .ds-section { margin:10px 12px; border-radius:16px; overflow:hidden; }
  .ds-section-head { font-size:0.65rem; font-weight:800; letter-spacing:0.09em; text-transform:uppercase; padding:10px 14px 4px; }
  .ds-section-body { padding:4px 14px 14px; }
  /* Section A â€” Listing (soft indigo) */
  .ds-a { background:#EEF2FF; }
  .ds-a .ds-section-head { color:#4338CA; }
  /* Section B â€” Location (soft green) */
  .ds-b { background:#F0FDF4; }
  .ds-b .ds-section-head { color:#166534; }
  /* Section C â€” Schools (soft purple) */
  .ds-c { background:#FAF5FF; }
  .ds-c .ds-section-head { color:#6B21A8; }
  /* Section D â€” Your Take (soft amber) */
  .ds-d { background:#FFFBEB; }
  .ds-d .ds-section-head { color:#92400E; }
  /* Section E â€” Links (white) */
  .ds-e { background:#fff; }
  .ds-e .ds-section-head { color:#2c2c2c; }
  /* Spec chips */
  .ds-specs { display:flex; flex-wrap:wrap; gap:8px; padding:6px 0 4px; }
  .ds-spec { background:rgba(0,0,0,0.06); border-radius:10px; padding:6px 12px; font-size:0.85rem; font-weight:600; display:flex; align-items:center; gap:5px; }
  .ds-spec span { font-weight:400; color:#666; font-size:0.78rem; }
  /* Feature tags */
  .ds-tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
  .ds-tag-yes { background:#dcfce7; color:#166534; border-radius:8px; padding:5px 10px; font-size:0.78rem; font-weight:600; }
  .ds-tag-no { background:#fee2e2; color:#991b1b; border-radius:8px; padding:5px 10px; font-size:0.78rem; }
  .ds-tag-neu { background:#e5e7eb; color:#374151; border-radius:8px; padding:5px 10px; font-size:0.78rem; }
  /* School rows */
  .ds-school-row { padding:7px 0; border-bottom:1px solid rgba(0,0,0,0.05); display:flex; flex-direction:column; gap:2px; }
  .ds-school-row:last-child { border-bottom:none; }
  .ds-school-name { font-size:0.88rem; font-weight:600; color:#2c2c2c; }
  .ds-school-meta { font-size:0.75rem; color:#666; }
  .ds-ofsted-out { color:#166534; font-weight:700; }
  .ds-ofsted-good { color:#1d4ed8; font-weight:700; }
  .ds-ofsted-ri { color:#b45309; font-weight:700; }
  /* Status pills */
  .ds-status-row { display:flex; flex-wrap:wrap; gap:7px; padding:8px 0; }
  .ds-pill { padding:9px 14px; border-radius:20px; font-size:0.82rem; font-weight:600; border:2px solid transparent; cursor:pointer; background:#fff; color:#555; border-color:#e5e7eb; transition:all 0.15s; }
  .ds-pill.active { color:white; border-color:transparent; }
  .ds-pill-new.active { background:#1d4ed8; }
  .ds-pill-viewing.active { background:#b45309; }
  .ds-pill-viewed.active { background:#7c3aed; }
  .ds-pill-interested.active { background:#166534; }
  .ds-pill-offer.active { background:#991b1b; }
  .ds-pill-rejected.active { background:#6b7280; }
  /* Stars */
  .ds-stars { display:flex; gap:6px; padding:8px 0; }
  .ds-star { font-size:1.8rem; cursor:pointer; transition:transform 0.1s; line-height:1; }
  .ds-star:active { transform:scale(1.3); }
  /* Text areas */
  .ds-textarea { width:100%; padding:10px 12px; border:1px solid rgba(0,0,0,0.1); border-radius:10px; font-size:0.9rem; font-family:inherit; background:rgba(255,255,255,0.7); resize:vertical; min-height:70px; margin-top:6px; }
  .ds-label { font-size:0.72rem; font-weight:700; text-transform:uppercase; letter-spacing:0.05em; color:#999; margin-top:10px; display:block; }
  /* Save button */
  .ds-save-btn { width:100%; padding:15px; background:#2c2c2c; color:white; border:none; border-radius:14px; font-size:1rem; font-weight:700; cursor:pointer; margin-top:12px; }
  /* Link buttons */
  .ds-link-btn { display:flex; align-items:center; justify-content:space-between; padding:13px 16px; background:#f8f8f8; border-radius:12px; margin-bottom:8px; text-decoration:none; color:#2c2c2c; font-size:0.9rem; font-weight:600; border:1px solid #eee; }
  .ds-link-btn:last-child { margin-bottom:0; }
  .ds-link-chevron { color:#aaa; font-size:1rem; }
  /* Summary expand */
  .ds-summary { font-size:0.83rem; color:#555; line-height:1.55; margin-top:6px; }
  /* Close + edit bar */
  .ds-topbar { display:flex; justify-content:space-between; align-items:center; padding:10px 16px 0; }
  .ds-close-btn { background:rgba(0,0,0,0.08); border:none; border-radius:50%; width:34px; height:34px; font-size:1rem; cursor:pointer; display:flex; align-items:center; justify-content:center; color:#555; }
  .ds-edit-btn { background:#2c2c2c; color:white; border:none; border-radius:20px; padding:7px 16px; font-size:0.82rem; font-weight:600; cursor:pointer; }
  /* Desktop */
  @media(min-width:641px){
    .ds-overlay { align-items:center; padding:20px; }
    .ds-sheet { border-radius:20px; max-width:560px; margin:auto; max-height:88vh; }
    .ds-slide img { height:320px; }
  }

  /* â”€â”€ ADD/EDIT MODAL â”€â”€ */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 300; justify-content: center; align-items: flex-start; padding: 16px; overflow-y: auto; }
  .modal-overlay.open { display: flex; }
  .modal { background: white; border-radius: 16px; padding: 20px; width: 100%; max-width: 620px; margin: auto; position:relative; }
  .modal h2 { margin-bottom: 16px; font-size: 1.1rem; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .form-group { display: flex; flex-direction: column; gap: 4px; }
  .form-group.full { grid-column: 1 / -1; }
  .form-group label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #888; font-weight: 600; }
  .form-group input, .form-group select, .form-group textarea { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; font-family: inherit; }
  .form-group textarea { resize: vertical; min-height: 60px; }
  .modal-close-x { position: absolute; top: 14px; right: 14px; background: #f0f0f0; border: none; border-radius: 50%; width: 34px; height: 34px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #555; line-height: 1; }
  .modal-close-x:hover { background: #e0e0e0; }
  .modal-actions { display: flex; gap: 10px; margin-top: 16px; justify-content: flex-end; }
  .btn-save { padding: 10px 22px; background: #2c2c2c; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; font-weight: 600; }
  .btn-cancel { padding: 10px 22px; background: #eee; color: #333; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; }
  .btn-delete { padding: 10px 22px; background: #c0392b; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.95rem; margin-right: auto; }
  .section-divider { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: #aaa; font-weight: 600; grid-column: 1 / -1; margin-top: 4px; border-top: 1px solid #eee; padding-top: 8px; }

  /* â”€â”€ LIGHTBOX â”€â”€ */
  .lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 300; flex-direction: column; align-items: center; justify-content: center; }
  .lightbox.open { display: flex; }
  .lb-close { position: fixed; top: 14px; right: 16px; background: rgba(255,255,255,0.15); border: none; color: white; font-size: 1.4rem; cursor: pointer; z-index: 301; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  .lb-prev, .lb-next { position: fixed; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.15); border: none; color: white; font-size: 2rem; cursor: pointer; padding: 10px 14px; border-radius: 8px; z-index: 301; }
  .lb-prev { left: 8px; }
  .lb-next { right: 8px; }
  .lb-tabs { display: flex; gap: 8px; margin-bottom: 10px; }
  .lb-tab { padding: 6px 16px; background: rgba(255,255,255,0.15); color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 0.82rem; }
  .lb-tab.active { background: white; color: #2c2c2c; font-weight: 600; }
  .lb-img { max-width: 92vw; max-height: 72vh; object-fit: contain; border-radius: 6px; }
  .lb-caption { color: rgba(255,255,255,0.6); font-size: 0.8rem; margin-top: 8px; }
  .lb-thumbs { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; justify-content: center; max-width: 92vw; }
  .lb-thumb { width: 54px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer; opacity: 0.5; border: 2px solid transparent; }
  .lb-thumb.active { opacity: 1; border-color: white; }

  /* â”€â”€ MOBILE OVERRIDES â”€â”€ */
  @media (max-width: 640px) {
    /* Header */
    .header-img { height: 110px; }
    .header-img-title h1 { font-size: 1.2rem; }
    .header-bar { padding: 6px 12px; }
    #last-updated { display: none; }
    #remote-updated { display: none; }
    .filter-toggle-btn { display: flex; font-size: 0.8rem; padding: 7px 14px; }

    /* Filter drawer - bottom sheet */
    .filters {
      display: none;
      position: fixed; bottom: 0; left: 0; right: 0;
      max-height: 88vh; overflow-y: auto;
      border-radius: 22px 22px 0 0;
      border-bottom: none;
      box-shadow: 0 -6px 30px rgba(0,0,0,0.22);
      z-index: 70;
      flex-direction: column;
      padding: 8px 16px 24px;
      gap: 0;
    }
    .filters.open { display: flex; }
    .filters::before { content: ''; display: block; width: 36px; height: 4px; background: #ddd; border-radius: 4px; margin: 10px auto 16px; flex-shrink: 0; }

    /* 2-column filter grid on mobile */
    .filter-group { width: 100%; }
    .filters-inner-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 100%; }
    .filters-inner-grid .filter-group-wide { grid-column: 1 / -1; }
    .filter-group select, .filter-group input[type=number] { width: 100%; font-size: 0.95rem; padding: 11px 10px; border-radius: 10px; }
    .filter-group input[type=range] { width: 100%; height: 6px; }
    .filter-group label { font-size: 0.68rem; margin-bottom: 2px; }
    .price-display { font-size: 0.82rem; font-weight: 600; color: #2c2c2c; }

    /* Buttons in filter sheet */
    .filter-btns-row { display: flex; gap: 10px; width: 100%; margin-top: 16px; }
    .reset-btn { flex: 1; padding: 13px; font-size: 0.9rem; border-radius: 12px; background: #f0f0f0; color: #2c2c2c; }
    .filters-close-btn { display: flex; flex: 2; align-items: center; justify-content: center; padding: 13px; font-size: 0.95rem; border-radius: 12px; }

    /* Stats */
    .stats-bar { padding: 7px 12px; font-size: 0.8rem; font-weight: 600; }

    /* Cards - minimal mobile view */
    .grid { grid-template-columns: 1fr; gap: 10px; padding: 10px 10px 90px; }
    .card-img { height: 220px; }
    .card-img-overlay { display: block; }
    .card-header { display: none; }
    .card-body .tags { display: none; }
    .card-body > div[style*="color:#555"] { display: none; } /* other detail */
    .add-btn { bottom: 16px; right: 12px; width: 50px; height: 50px; font-size: 1.4rem; }

    /* Modal slides up from bottom */
    .form-grid { grid-template-columns: 1fr; }
    .modal { padding: 16px; border-radius: 20px 20px 0 0; margin: auto 0 0 0; }
    .modal-overlay { align-items: flex-end; padding: 0; }
  }

  /* â”€â”€ DESKTOP â”€â”€ */
  @media (min-width: 641px) {
    .header-img { height: 200px; }
    header h1 { font-size: 1.3rem; }
    .filter-toggle-btn { display: none; }
    .filters { padding: 14px 20px; }
    .filters-close-btn { display: none !important; }
    .grid { padding: 16px 20px; gap: 16px; }
    .stats-bar { padding: 8px 20px; }
    header { position: relative; }
  }
</style>
</head>
<body>

<header>
  <div class="header-img-wrap">
    <img class="header-img" src="banner.jpg" alt="Cotswolds">
    <div class="header-img-title"><h1>Wrong Move by Slim Charles &amp; Co</h1></div>
  </div>
  <div class="header-bar">
    <span style="font-size:0.78rem;opacity:0.7">Cheltenham &amp; surrounds</span>
    <div class="header-right">
      <span id="last-updated">0 properties</span>
      <span id="remote-updated"></span>
      <button class="filter-toggle-btn" id="filter-toggle-btn" onclick="toggleFilters()">âš™ï¸ Filters</button>
    </div>
  </div>
</header>

<div class="filters-backdrop" id="filters-backdrop" onclick="toggleFilters()"></div>
<div class="filters" id="filters-panel">
  <div class="filter-group">
    <label>Max Price</label>
    <input type="range" id="f-price" min="200000" max="5000000" step="50000" value="1200000">
    <div class="price-display" id="price-display">Up to Â£1,200,000</div>
  </div>
  <div class="filter-group">
    <label>Min Beds</label>
    <select id="f-beds">
      <option value="0">Any</option>
      <option value="4" selected>4+</option>
      <option value="5">5+</option>
      <option value="6">6+</option>
    </select>
  </div>
  <div class="filter-group">
    <label>Min Baths</label>
    <select id="f-baths">
      <option value="0" selected>Any</option>
      <option value="2">2+</option>
      <option value="3">3+</option>
    </select>
  </div>
  <div class="filter-group">
    <label>Property Type</label>
    <select id="f-type">
      <option value="">Any</option>
      <option value="Detached">Detached</option>
      <option value="Semi-detached">Semi-detached</option>
      <option value="Terraced">Terraced</option>
      <option value="Cottage">Cottage</option>
      <option value="Farmhouse">Farmhouse</option>
      <option value="Barn">Barn</option>
      <option value="Country House">Country House</option>
      <option value="Manor">Manor</option>
      <option value="Period House">Period House</option>
      <option value="Townhouse">Townhouse</option>
      <option value="Bungalow">Bungalow</option>
    </select>
  </div>
  <div class="filter-group">
    <label>Max Distance from Cheltenham</label>
    <input type="range" id="f-radius" min="1" max="20" step="1" value="8">
    <div class="price-display" id="radius-display">Within 8 miles</div>
  </div>
  <select id="f-garden" style="display:none"></select>
  <select id="f-outbuildings" style="display:none"></select>
  <div class="filter-group">
    <label>Primary School</label>
    <select id="f-school">
      <option value="">Any Ofsted</option>
      <option value="Outstanding">Outstanding</option>
      <option value="Good">Good+</option>
    </select>
  </div>
  <div class="filter-group">
    <label>Secondary School</label>
    <select id="f-sec-school">
      <option value="">Any Ofsted</option>
      <option value="Outstanding">Outstanding</option>
      <option value="Good">Good+</option>
    </select>
  </div>
  <div class="filter-group">
    <label>Status</label>
    <select id="f-status">
      <option value="">All</option>
      <option value="New">New</option>
      <option value="Viewing Booked">Viewing Booked</option>
      <option value="Viewed">Viewed</option>
      <option value="Interested">Interested</option>
      <option value="Offer Made">Offer Made</option>
      <option value="Rejected">Rejected</option>
    </select>
  </div>
  <div class="filter-group">
    <label>Min Rating</label>
    <select id="f-rating">
      <option value="0">Any</option>
      <option value="3">3+ â­</option>
      <option value="4">4+ â­</option>
      <option value="5">5 â­</option>
    </select>
  </div>
  <div class="filter-group">
    <label>Sort By</label>
    <select id="f-sort">
      <option value="default">Default</option>
<option value="price-asc">Price: Low to High</option>
      <option value="price-desc" selected>Price: High to Low</option>
      <option value="beds-desc">Most Beds</option>
      <option value="rating-desc">My Rating</option>
      <option value="school-dist">School Distance</option>
    </select>
  </div>
  <div class="filter-btns-row">
    <button class="reset-btn" onclick="resetFilters()">Reset</button>
    <button class="filters-close-btn" onclick="toggleFilters()">Show Results</button>
  </div>
</div>

<div class="stats-bar" id="stats-bar">Showing 0 properties</div>
<div class="grid" id="grid"></div>
<button class="add-btn" onclick="openModal()" title="Add property">+</button>

<!-- Lightbox -->
<div class="lightbox" id="lightbox">
  <button class="lb-close" onclick="closeLightbox()">âœ•</button>
  <button class="lb-prev" onclick="lbNav(-1)">&#8249;</button>
  <button class="lb-next" onclick="lbNav(1)">&#8250;</button>
  <div class="lb-tabs" id="lb-tabs"></div>
  <img class="lb-img" id="lb-img" src="" alt="">
  <div class="lb-caption" id="lb-caption"></div>
  <div class="lb-thumbs" id="lb-thumbs"></div>
</div>

<!-- â”€â”€ DETAIL SHEET â”€â”€ -->
<div class="ds-overlay" id="ds-overlay" onclick="if(event.target===this)closeDetail()">
 <div class="ds-sheet" id="ds-sheet">
  <div class="ds-handle"></div>
  <div class="ds-topbar">
   <button class="ds-close-btn" onclick="closeDetail()">âœ•</button>
   <button class="ds-edit-btn" onclick="openEditFromDetail()">Edit âœï¸</button>
  </div>
  <!-- Photo carousel -->
  <div class="ds-carousel" id="ds-carousel"></div>
  <div class="ds-dots" id="ds-dots"></div>
  <!-- Hero -->
  <div class="ds-hero">
   <div class="ds-price" id="ds-price"></div>
   <div class="ds-address" id="ds-address"></div>
   <div class="ds-location" id="ds-location"></div>
  </div>
  <!-- Section A: Listing Details -->
  <div class="ds-section ds-a">
   <div class="ds-section-head">ğŸ¡ Property Details</div>
   <div class="ds-section-body">
    <div class="ds-specs" id="ds-specs"></div>
    <div class="ds-tags" id="ds-tags"></div>
    <div class="ds-summary" id="ds-summary"></div>
    <div style="margin-top:8px;font-size:0.75rem;color:#888;" id="ds-agent"></div>
    <div style="margin-top:4px;display:flex;gap:6px;flex-wrap:wrap;" id="ds-sources"></div>
   </div>
  </div>
  <!-- Section B: Location -->
  <div class="ds-section ds-b">
   <div class="ds-section-head">ğŸ“ Location</div>
   <div class="ds-section-body" id="ds-location-body"></div>
  </div>
  <!-- Section C: Schools -->
  <div class="ds-section ds-c">
   <div class="ds-section-head">ğŸ« Schools</div>
   <div class="ds-section-body" id="ds-schools"></div>
  </div>
  <!-- Section D: Your Take -->
  <div class="ds-section ds-d">
   <div class="ds-section-head">âœ… Your Take</div>
   <div class="ds-section-body">
    <span class="ds-label">Status</span>
    <div class="ds-status-row">
     <button class="ds-pill ds-pill-new" onclick="setStatus('New')">New</button>
     <button class="ds-pill ds-pill-viewing" onclick="setStatus('Viewing Booked')">Viewing</button>
     <button class="ds-pill ds-pill-viewed" onclick="setStatus('Viewed')">Viewed</button>
     <button class="ds-pill ds-pill-interested" onclick="setStatus('Interested')">Interested</button>
     <button class="ds-pill ds-pill-offer" onclick="setStatus('Offer Made')">Offer</button>
     <button class="ds-pill ds-pill-rejected" onclick="setStatus('Rejected')">Rejected</button>
    </div>
    <span class="ds-label">Rating</span>
    <div class="ds-stars" id="ds-stars">
     <span class="ds-star" onclick="setRating(1)">â˜†</span>
     <span class="ds-star" onclick="setRating(2)">â˜†</span>
     <span class="ds-star" onclick="setRating(3)">â˜†</span>
     <span class="ds-star" onclick="setRating(4)">â˜†</span>
     <span class="ds-star" onclick="setRating(5)">â˜†</span>
    </div>
    <span class="ds-label">Viewing Date</span>
    <input type="date" id="ds-view-date" style="width:100%;padding:10px;border:1px solid rgba(0,0,0,0.1);border-radius:10px;font-size:1rem;background:rgba(255,255,255,0.7);margin-top:6px;">
    <span class="ds-label">Pros</span>
    <textarea class="ds-textarea" id="ds-pros" placeholder="One per line â€” what you love about it"></textarea>
    <span class="ds-label">Cons</span>
    <textarea class="ds-textarea" id="ds-cons" placeholder="One per line â€” any concerns"></textarea>
    <span class="ds-label">Notes</span>
    <textarea class="ds-textarea" id="ds-notes" placeholder="Anything else to remember..."></textarea>
    <button class="ds-save-btn" onclick="saveAssessment()">Save</button>
   </div>
  </div>
  <!-- Section E: Links -->
  <div class="ds-section ds-e">
   <div class="ds-section-head">ğŸ”— View Listing</div>
   <div class="ds-section-body" id="ds-links"></div>
  </div>
  <div style="height:20px;"></div>
 </div>
</div>

<!-- â”€â”€ ADD/EDIT MODAL â”€â”€ -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <button class="modal-close-x" onclick="closeModal()" title="Close">âœ•</button>
    <h2 id="modal-title">Add Property</h2>
    <div id="modal-sources" style="font-size:0.75rem;color:#888;margin:-10px 0 12px;"></div>
    <div class="form-grid">
      <div class="section-divider">ğŸ“ Property Details</div>
      <div class="form-group full"><label>Address</label><input type="text" id="f-address" placeholder="123 Example Lane"></div>
      <div class="form-group"><label>Town / Village</label><input type="text" id="f-town" placeholder="Prestbury"></div>
      <div class="form-group"><label>Postcode</label><input type="text" id="f-postcode" placeholder="GL52 3XX"></div>
      <div class="form-group"><label>Asking Price (Â£)</label><input type="number" id="f-asking-price" placeholder="850000"></div>
      <div class="form-group"><label>Price Reduced?</label>
        <select id="f-price-reduced"><option value="No">No</option><option value="Yes">Yes</option></select>
      </div>
      <div class="form-group"><label>Beds</label><input type="number" id="f-beds-count" placeholder="4" min="1"></div>
      <div class="form-group"><label>Baths</label><input type="number" id="f-baths-count" placeholder="2" min="1"></div>
      <div class="form-group"><label>Reception Rooms</label><input type="number" id="f-receptions" placeholder="3" min="0"></div>
      <div class="form-group"><label>Property Type</label>
        <select id="f-prop-type"><option>Detached</option><option>Semi-detached</option><option>Terraced</option><option>Barn</option><option>Cottage</option><option>Farmhouse</option><option>Other</option></select>
      </div>
      <div class="form-group"><label>Tenure</label>
        <select id="f-tenure"><option>Freehold</option><option>Leasehold</option></select>
      </div>
      <div class="form-group"><label>New Build?</label>
        <select id="f-new-build"><option value="No">No</option><option value="Yes">Yes</option></select>
      </div>
      <div class="section-divider">ğŸŒ³ Garden & Grounds</div>
      <div class="form-group"><label>Garden</label>
        <select id="f-garden-yn"><option value="Yes">Yes</option><option value="No">No</option></select>
      </div>
      <div class="form-group"><label>Garden Size</label><input type="text" id="f-garden-size" placeholder="Large / 0.5 acres"></div>
      <div class="form-group"><label>Outbuildings</label>
        <select id="f-out-yn"><option value="Yes">Yes</option><option value="No">No</option></select>
      </div>
      <div class="form-group"><label>Outbuilding Details</label><input type="text" id="f-out-detail" placeholder="Barn, Workshop, Store"></div>
      <div class="form-group"><label>Driveway</label>
        <select id="f-drive"><option value="Yes">Yes</option><option value="No">No</option></select>
      </div>
      <div class="form-group"><label>Garage</label>
        <select id="f-garage"><option value="Yes">Yes</option><option value="No">No</option></select>
      </div>
      <div class="form-group full"><label>Other Features</label><input type="text" id="f-other" placeholder="Pool, annexe, tennis court..."></div>
      <div class="section-divider">ğŸ—ºï¸ Location</div>
      <div class="form-group"><label>Distance to Cheltenham (miles)</label><input type="number" id="f-distance" placeholder="1.8" step="0.1"></div>
      <div class="form-group"><label>Rural / Suburban / Village</label>
        <select id="f-rural"><option>Rural</option><option>Village</option><option>Suburban</option><option>Town</option></select>
      </div>
      <div class="section-divider">ğŸ¢ Listing</div>
      <div class="form-group"><label>Estate Agent</label><input type="text" id="f-agent" placeholder="Hamptons"></div>
      <div class="form-group"><label>Date Listed</label><input type="date" id="f-date-listed"></div>
      <div class="form-group full"><label>Rightmove Link</label><input type="url" id="f-rm-link"></div>
      <div class="form-group full"><label>Zoopla Link</label><input type="url" id="f-zp-link"></div>
      <div class="form-group full"><label>OnTheMarket Link</label><input type="url" id="f-otm-link"></div>
      <div class="form-group full" id="modal-agent-links-wrap" style="display:none">
        <label>Agent Links</label>
        <div id="modal-agent-links" style="font-size:0.82rem;display:flex;flex-wrap:wrap;gap:6px;padding:8px 0;"></div>
      </div>
      <div class="section-divider">âœ… Your Assessment</div>
      <div class="form-group"><label>Status</label>
        <select id="f-stat"><option>New</option><option>Viewing Booked</option><option>Viewed</option><option>Interested</option><option>Offer Made</option><option>Rejected</option></select>
      </div>
      <div class="form-group"><label>Viewing Date</label><input type="date" id="f-view-date"></div>
      <div class="form-group"><label>Our Rating (1-5)</label>
        <select id="f-our-rating"><option value="">â€”</option><option value="1">1 â­</option><option value="2">2 â­</option><option value="3">3 â­</option><option value="4">4 â­</option><option value="5">5 â­</option></select>
      </div>
      <div class="form-group full"><label>Pros</label><textarea id="f-pros" placeholder="One per line"></textarea></div>
      <div class="form-group full"><label>Cons</label><textarea id="f-cons" placeholder="One per line"></textarea></div>
      <div class="form-group full"><label>Notes</label><textarea id="f-notes"></textarea></div>
    </div>
    <div class="modal-actions">
      <button class="btn-delete" id="btn-delete" onclick="deleteProperty()" style="display:none">Delete</button>
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-save" onclick="saveProperty()">Save</button>
    </div>
  </div>
</div>

<script>
var properties = [];
var editingId = null;
var lbImages = [];
var lbIndex = 0;
var lbMode = 'photos';
var lbCurrentId = null;

function toggleFilters() {
  var panel = document.getElementById('filters-panel');
  var backdrop = document.getElementById('filters-backdrop');
  var btn = document.getElementById('filter-toggle-btn');
  var isOpen = panel.classList.toggle('open');
  backdrop.classList.toggle('open', isOpen);
  if (btn) btn.classList.toggle('active', isOpen);
  document.body.style.overflow = isOpen ? 'hidden' : '';
}

var TODAY_STR = new Date().toISOString().slice(0,10);
var WEEK_AGO  = new Date(Date.now() - 7*24*60*60*1000).toISOString().slice(0,10);
function isNewListing(p) {
  var d = p.lastUpdated || p.dateListed || '';
  return d >= WEEK_AGO && d <= TODAY_STR;
}

function fmt(n) {
  if (!n) return 'â€”';
  return 'Â£' + Number(n).toLocaleString('en-GB');
}
function stars(n) { return n ? 'â­'.repeat(Number(n)) : ''; }
function ofstedClass(o) {
  if (o === 'Outstanding') return 'ofsted-outstanding';
  if (o === 'Good') return 'ofsted-good';
  if (o === 'Requires Improvement') return 'ofsted-ri';
  return '';
}
function statusClass(s) {
  var m = {'New':'new','Viewing Booked':'viewing','Viewed':'viewed','Interested':'interested','Offer Made':'offer','Rejected':'rejected'};
  return 'status-' + (m[s] || 'new');
}

// CATCHMENT SCHOOLS by postcode sector (5-char, space-stripped)
var CATCHMENT_PRI = {
  // GL50 - central Cheltenham
  'GL501':'St Edwards CE Primary','GL502':'St Gregorys Catholic Primary',
  'GL503':'All Saints Academy','GL504':'All Saints Academy',
  // GL51 - west/northwest Cheltenham
  'GL510':'Up Hatherley CE Junior School','GL511':'Hatherley Infant School',
  'GL513':'Swindon Village Primary Academy','GL515':'Swindon Village Primary Academy',
  'GL516':'Hatherley Infant School','GL517':'Warden Hill Primary',
  'GL518':'Benhall Infant School','GL519':'Shurdington CE Primary',
  // GL52 - north/northeast Cheltenham, Prestbury, Bishops Cleeve
  'GL521':'Bishops Cleeve Primary','GL522':'Bishops Cleeve Primary',
  'GL523':'Swindon Village Primary Academy','GL524':'Prestbury CE Primary',
  'GL525':'Prestbury CE Primary','GL526':'St Philip and St James CE Primary',
  'GL527':'Woodmancote Primary','GL528':'Gotherington Primary',
  // GL53 - south Cheltenham, Charlton Kings, Leckhampton
  'GL530':'Naunton Park Primary','GL531':'Leckhampton CE Primary',
  'GL532':'Charlton Kings Infant School','GL533':'Charlton Kings Infant School',
  'GL534':'Charlton Kings Infant School','GL537':'Coberley CE Primary',
  'GL538':'Charlton Kings Infant School','GL539':'Charlton Kings Infant School',
};
var CATCHMENT_SEC = {
  'GL501':'Cheltenham Bournside School','GL502':'Cheltenham Bournside School',
  'GL503':'Cheltenham Bournside School','GL504':'Cheltenham Bournside School',
  'GL510':'Cheltenham Bournside School','GL511':'Cheltenham Bournside School',
  'GL513':'Cheltenham Bournside School','GL515':'Cheltenham Bournside School',
  'GL516':'Cheltenham Bournside School','GL517':'Cheltenham Bournside School',
  'GL518':'Cheltenham Bournside School','GL519':'Cheltenham Bournside School',
  'GL521':'Cleeve School','GL522':'Cleeve School',
  'GL523':'Cheltenham Bournside School','GL524':'Balcarras School',
  'GL525':'Balcarras School','GL526':'Cleeve School',
  'GL527':'Cleeve School','GL528':'Cleeve School',
  'GL530':'Balcarras School','GL531':'Balcarras School',
  'GL532':'Balcarras School','GL533':'Balcarras School',
  'GL534':'Balcarras School','GL537':'Balcarras School',
  'GL538':'Balcarras School','GL539':'Balcarras School',
};
var OFSTED_PRI = {
  'Naunton Park Primary':'Outstanding',
  'Prestbury CE Primary':'Good','St Philip and St James CE Primary':'Good',
  'Swindon Village Primary Academy':'Good','Bishops Cleeve Primary':'Good',
  'Leckhampton CE Primary':'Good','Charlton Kings Infant School':'Good',
  'Up Hatherley CE Junior School':'Good','Hatherley Infant School':'Good',
  'Benhall Infant School':'Good','Shurdington CE Primary':'Good',
  'St Gregorys Catholic Primary':'Good','All Saints Academy':'Good',
  'St Edwards CE Primary':'Good','Warden Hill Primary':'Good',
  'Woodmancote Primary':'Good','Gotherington Primary':'Good',
  'Coberley CE Primary':'Good'
};
var OFSTED_SEC = {
  'Balcarras School':'Outstanding','Cheltenham Bournside School':'Outstanding',
  'Cleeve School':'Good'
};
// District-level fallback for properties with only outcode (GL50/GL51/GL52/GL53)
var DISTRICT_PRI = {
  'GL50':'St Edwards CE Primary','GL51':'Hatherley Infant School',
  'GL52':'Prestbury CE Primary','GL53':'Naunton Park Primary',
  'GL54':'Bourton-on-the-Water Primary'
};
var DISTRICT_SEC = {
  'GL50':'Cheltenham Bournside School','GL51':'Cheltenham Bournside School',
  'GL52':'Balcarras School','GL53':'Balcarras School','GL54':'Chipping Campden School'
};

function getCatchmentHTML(p) {
  var postcode = p.postcode || '';
  // 1. Use merged OSM school data if available
  var priData = p.nearestPrimary || null;
  var secData = p.nearestSecondary || null;
  var html = '';
  if (priData && priData.name) {
    var o = priData.ofsted || '';
    html += '<div class="school-info">ğŸ« <strong>Primary:</strong> ' + priData.name
      + (priData.distance ? ' <span style="color:#aaa">(' + priData.distance + 'mi)</span>' : '')
      + (o ? ' â€” <span class="' + ofstedClass(o) + '">' + o + '</span>' : '') + '</div>';
  }
  if (secData && secData.name) {
    var os = secData.ofsted || '';
    html += '<div class="school-info">ğŸ“ <strong>Secondary:</strong> ' + secData.name
      + (secData.distance ? ' <span style="color:#aaa">(' + secData.distance + 'mi)</span>' : '')
      + (os ? ' â€” <span class="' + ofstedClass(os) + '">' + os + '</span>' : '') + '</div>';
  }
  if (html) return html;
  // 2. Fall back to hardcoded catchment table
  if (!postcode) return '';
  var pc = postcode.toUpperCase().replace(/\s/g,'');
  var sector = pc.slice(0,5);
  var district = pc.slice(0,4); // e.g. GL50, GL51, GL52, GL53
  var pri = CATCHMENT_PRI[sector] || DISTRICT_PRI[district] || null;
  var sec = CATCHMENT_SEC[sector] || DISTRICT_SEC[district] || null;
  var isDistrictLevel = !CATCHMENT_PRI[sector] && pri; // using fallback
  if (pri) {
    var oo = OFSTED_PRI[pri] || '';
    html += '<div class="school-info">ğŸ« <strong>Primary:</strong> ' + pri
      + (oo ? ' â€” <span class="' + ofstedClass(oo) + '">' + oo + '</span>' : '')
      + (isDistrictLevel ? ' <span style="color:#bbb;font-size:0.68rem">(approx)</span>' : '')
      + '</div>';
  }
  if (sec) {
    var oss = OFSTED_SEC[sec] || '';
    html += '<div class="school-info">ğŸ“ <strong>Secondary:</strong> ' + sec
      + (oss ? ' â€” <span class="' + ofstedClass(oss) + '">' + oss + '</span>' : '')
      + (isDistrictLevel ? ' <span style="color:#bbb;font-size:0.68rem">(approx)</span>' : '')
      + '</div>';
  }
  if (!pri && !sec && postcode) {
    html = '<div class="school-info"><a href="https://www.gloucestershire.gov.uk/education-and-learning/schools-and-admissions/school-admissions/find-your-catchment-area-school/?postcode=' + encodeURIComponent(postcode) + '" target="_blank" onclick="event.stopPropagation()">Check catchment â†—</a></div>';
  }
  return html;
}

function getLinksHTML(p) {
  var links = '';
  // Use allLinks if populated (merged data), else fall back to individual fields
  var all = p.allLinks || {};
  var rmUrl = all.rightmove || p.rmLink || '';
  var otmUrl = all.onthemarket || p.otmLink || '';
  var zpUrl = p.zpLink || '';
  if (rmUrl) links += '<a href="' + rmUrl + '" target="_blank" onclick="event.stopPropagation()">RM</a>';
  if (otmUrl) links += '<a href="' + otmUrl + '" target="_blank" onclick="event.stopPropagation()">OTM</a>';
  if (zpUrl) links += '<a href="' + zpUrl + '" target="_blank" onclick="event.stopPropagation()">ZP</a>';
  // Agent-direct links (non-portal sources)
  var portalSources = new Set(['rightmove','onthemarket','zoopla','']);
  Object.keys(all).forEach(function(src) {
    if (!portalSources.has(src) && all[src]) {
      var label = src.split(' ')[0].slice(0,6);
      links += '<a href="' + all[src] + '" target="_blank" onclick="event.stopPropagation()" title="' + src + '">' + label + '</a>';
    }
  });
  // Standalone agentLink (not yet in allLinks)
  if (!Object.keys(all).length && p.agentLink) {
    var agentLabel = (p.agent||'Agent').split(' ')[0].slice(0,6);
    links += '<a href="' + p.agentLink + '" target="_blank" onclick="event.stopPropagation()" title="' + (p.agent||'Agent') + '">' + agentLabel + '</a>';
  }
  return links;
}

function getSourceBadges(p) {
  var sources = p.sources || [p.source || ''];
  var icons = {
    'rightmove':'ğŸ”´','onthemarket':'ğŸŸ¢','zoopla':'ğŸŸ£',
    'Read Maurice':'ğŸ ','Nick Griffith Estate Agents':'ğŸ ',
    'Kingsley Evans':'ğŸ ','CJ Hole Cheltenham':'ğŸ ',
    'Peter Ball & Co':'ğŸ ','Charles Lear & Co':'ğŸ ',
    'Elliot Oliver':'ğŸ '
  };
  return sources.filter(Boolean).map(function(s) {
    var icon = icons[s] || 'ğŸ“‹';
    var short = s === 'rightmove' ? 'RM' : s === 'onthemarket' ? 'OTM' :
                s.split(' ')[0].slice(0,8);
    return '<span style="font-size:0.65rem;padding:2px 6px;background:#f0f0f0;border-radius:8px;color:#555;" title="' + s + '">' + icon + ' ' + short + '</span>';
  }).join(' ');
}

function getFilters() {
  return {
    price: parseInt(document.getElementById('f-price').value),
    beds: parseInt(document.getElementById('f-beds').value),
    baths: parseInt(document.getElementById('f-baths').value),
    type: document.getElementById('f-type').value,
    radius: parseFloat(document.getElementById('f-radius').value),
    garden: document.getElementById('f-garden').value || '',
    outbuildings: document.getElementById('f-outbuildings').value || '',
    school: document.getElementById('f-school').value,
    secSchool: document.getElementById('f-sec-school').value,
    status: document.getElementById('f-status').value,
    rating: parseInt(document.getElementById('f-rating').value) || 0,
    sort: document.getElementById('f-sort').value
  };
}

function matchesFilters(p, f) {
  if (p.askingPrice && p.askingPrice > f.price) return false;
  if (f.beds && (!p.beds || p.beds < f.beds)) return false;
  if (f.baths && p.baths && p.baths < f.baths) return false;
  if (f.type && p.propType !== f.type) return false;
  if (f.radius < 20 && p.distMiles != null && p.distMiles > f.radius) return false;
  if (f.garden === 'Yes' && p.garden === 'No') return false;
  if (f.outbuildings === 'Yes' && p.outbuildings === 'No') return false;
  if (f.status && p.status !== f.status) return false;
  if (f.rating && (!p.rating || p.rating < f.rating)) return false;
  // School filters â€” use merged OSM data first, fall back to catchment table
  if (f.school || f.secSchool) {
    var pc2 = (p.postcode||'').toUpperCase().replace(/\s/g,'');
    var sector2 = pc2.slice(0,5);
    // Primary
    var priOfsted = '';
    if (p.nearestPrimary && p.nearestPrimary.ofsted) {
      priOfsted = p.nearestPrimary.ofsted;
    } else {
      var priName = CATCHMENT_PRI[sector2];
      priOfsted = priName ? (OFSTED_PRI[priName]||'') : '';
    }
    // Secondary
    var secOfsted = '';
    if (p.nearestSecondary && p.nearestSecondary.ofsted) {
      secOfsted = p.nearestSecondary.ofsted;
    } else {
      var secName = CATCHMENT_SEC[sector2];
      secOfsted = secName ? (OFSTED_SEC[secName]||'') : '';
    }
    if (f.school === 'Outstanding' && priOfsted !== 'Outstanding') return false;
    if (f.school === 'Good' && !['Outstanding','Good'].includes(priOfsted)) return false;
    if (f.secSchool === 'Outstanding' && secOfsted !== 'Outstanding') return false;
    if (f.secSchool === 'Good' && !['Outstanding','Good'].includes(secOfsted)) return false;
  }
  return true;
}

function render() {
  var f = getFilters();
  var filtered = properties.filter(function(p) { return matchesFilters(p, f); });
  filtered.sort(function(a, b) {
    if (f.sort === 'price-asc') return (a.askingPrice||0) - (b.askingPrice||0);
    if (f.sort === 'price-desc') return (b.askingPrice||0) - (a.askingPrice||0);
    if (f.sort === 'beds-desc') return (b.beds||0) - (a.beds||0);
    if (f.sort === 'rating-desc') return (b.rating||0) - (a.rating||0);
    if (f.sort === 'school-dist') return (a.priDist||99) - (b.priDist||99);
    return 0;
  });
  var statsEl = document.getElementById('stats-bar');
  statsEl.innerHTML = '<strong>' + filtered.length + '</strong> properties' + (filtered.length < properties.length ? ' <span style="font-weight:400;opacity:0.6">of ' + properties.length + '</span>' : '');
  var btn = document.getElementById('filter-toggle-btn');
  if (btn) btn.innerHTML = '&#9881;&#65039; Filters &nbsp;<span style="background:white;color:#2c2c2c;border-radius:10px;padding:1px 7px;font-size:0.75rem;font-weight:700">' + filtered.length + '</span>';
  document.getElementById('last-updated').textContent = properties.length + ' properties';
  var grid = document.getElementById('grid');
  if (filtered.length === 0) {
    grid.innerHTML = '<div class="empty-state"><p>' + (properties.length === 0 ? 'No properties yet â€” click + to add your first listing' : 'No properties match your filters') + '</p></div>';
    return;
  }
  grid.innerHTML = filtered.map(function(p) {
    var priceHtml = fmt(p.askingPrice)
      + (p.priceReduced === 'Yes' ? '<span class="price-reduced">REDUCED</span>' : '')
      + (isNewListing(p) ? '<span class="new-listing">NEW</span>' : '')
      + (p.lastUpdated ? '<span style="font-size:0.72rem;color:#4a7fc1;margin-left:6px">' + (function(d){var pt=d.split('-');return pt.length===3?pt[2]+'/'+pt[1]+'/'+pt[0]:d;})(p.lastUpdated) + '</span>' : '');
    var hasPhotos = p.photos && p.photos.length > 0;
    var hasFP = p.floorPlans && p.floorPlans.length > 0;
    var rawImg = hasPhotos
      ? '<img class="card-img" src="' + p.photos[0] + '" alt="' + (p.address||'') + '" loading="lazy" referrerpolicy="no-referrer" onerror="this.outerHTML=\'<a href=\\\&quot;' + (p.rmLink||p.otmLink||'#') + '\\\&quot; target=\\\&quot;_blank\\\&quot; onclick=\\\&quot;event.stopPropagation()\\\&quot; class=\\\&quot;card-img-link\\\&quot;><div class=\\\&quot;card-img-placeholder\\\&quot;>ğŸ¡<br><span>View photos on Rightmove â†—</span></div></a>\'" onclick="event.stopPropagation();openLightbox(\'' + p.id + '\',0,\'photos\')">'
      : '<div class="card-img-placeholder">ğŸ¡</div>';
    var imgHtml = '<div class="card-img-wrap">' + rawImg
      + '<div class="card-img-overlay">'
      + '<div class="ov-address">' + (p.address||'Address TBC') + (p.town ? ', ' + p.town : '') + '</div>'
      + '<div class="ov-price">' + priceHtml + '</div>'
      + '</div></div>';
    var planBtn = hasFP
      ? '<a href="#" class="plan-btn" onclick="event.preventDefault();event.stopPropagation();openLightbox(\'' + p.id + '\',0,\'floorplan\')">ğŸ“ Plan</a>'
      : '';
    var school = getCatchmentHTML(p);
    var tags = '';
    if (p.garden === 'Yes') tags += '<span class="tag tag-yes">Garden âœ“</span>';
    if (p.outbuildings === 'Yes') tags += '<span class="tag tag-yes">Outbuildings âœ“</span>';
    if (p.driveway === 'Yes') tags += '<span class="tag tag-yes">Driveway âœ“</span>';
    if (p.garage === 'Yes') tags += '<span class="tag tag-yes">Garage âœ“</span>';
    if (p.tenure) tags += '<span class="tag tag-neutral">' + p.tenure + '</span>';
    var specs = '';
    if (p.beds) specs += '<div class="spec">ğŸ› <strong>' + p.beds + '</strong> beds</div>';
    if (p.baths) specs += '<div class="spec">ğŸš¿ <strong>' + p.baths + '</strong> baths</div>';
    if (p.receptions) specs += '<div class="spec">ğŸ›‹ <strong>' + p.receptions + '</strong> recep</div>';
    if (p.propType) specs += '<div class="spec">ğŸ  ' + p.propType + '</div>';
    if (p.distMiles) specs += '<div class="spec">ğŸ“ <strong>' + p.distMiles + 'mi</strong> from Cheltenham</div>';
    var prosCons = '';
    if (p.pros || p.cons) {
      prosCons = '<div class="pros-cons">';
      if (p.pros) prosCons += '<div class="pros"><h4>Pros</h4><ul>' + p.pros.split('\n').filter(Boolean).map(function(l){return '<li>'+l+'</li>';}).join('') + '</ul></div>';
      else prosCons += '<div></div>';
      if (p.cons) prosCons += '<div class="cons"><h4>Cons</h4><ul>' + p.cons.split('\n').filter(Boolean).map(function(l){return '<li>'+l+'</li>';}).join('') + '</ul></div>';
      else prosCons += '<div></div>';
      prosCons += '</div>';
    }
    var notes = p.notes ? '<div class="notes-section">' + p.notes + '</div>' : '';
    var linksHtml = getLinksHTML(p);
    var sourceBadges = getSourceBadges(p);
    // Thumbnail strip: first 4 photos + floorplan thumbnail
    var thumbStrip = '';
    var allPhotos = p.photos || [];
    var fps = p.floorPlans || [];
    if (allPhotos.length > 1 || fps.length > 0) {
      var thumbsHtml = '';
      var stripPhotos = allPhotos.slice(1, 5); // skip first (already shown as main)
      stripPhotos.forEach(function(img, i) {
        thumbsHtml += '<img class="card-thumb" src="' + img + '" referrerpolicy="no-referrer" loading="lazy"'
          + ' onclick="event.stopPropagation();openLightbox(\'' + p.id + '\',' + (i+1) + ',\'photos\')"'
          + ' onerror="this.style.display=\'none\'">';
      });
      if (fps.length > 0) {
        thumbsHtml += '<img class="card-thumb card-thumb-fp" src="' + fps[0] + '" referrerpolicy="no-referrer" loading="lazy"'
          + ' title="Floor Plan" onclick="event.stopPropagation();openLightbox(\'' + p.id + '\',0,\'floorplan\')"'
          + ' onerror="this.outerHTML=\'<div class=\\\"card-thumb card-thumb-fp\\\" onclick=\\\"event.stopPropagation();openLightbox(\\\\\\\"' + p.id + '\\\\\\\",0,\\\\\\\"floorplan\\\\\\\")\\\">ğŸ“</div>\'">';
      }
      if (allPhotos.length > 5) {
        thumbsHtml += '<div class="card-thumb-more" onclick="event.stopPropagation();openLightbox(\'' + p.id + '\',0,\'photos\')">+' + (allPhotos.length - 5) + '</div>';
      }
      thumbStrip = '<div class="card-thumb-strip">' + thumbsHtml + '</div>';
    }
    var photoCount = (p.photos||[]).length;
    var photoCountBadge = photoCount > 1
      ? '<span style="position:absolute;top:8px;right:8px;background:rgba(0,0,0,0.55);color:white;font-size:0.7rem;padding:2px 7px;border-radius:10px;pointer-events:none;">ğŸ“· ' + photoCount + '</span>'
      : '';
    // Badge inserted as last child of card-img-wrap (position:relative), so absolute positioning works
    var imgHtmlFinal = photoCountBadge
      ? imgHtml.slice(0, imgHtml.lastIndexOf('</div>')) + photoCountBadge + '</div>'
      : imgHtml;
    return '<div class="card" onclick="openDetail(\'' + p.id + '\')">'
      + imgHtmlFinal + thumbStrip
      + '<div class="card-header">'
      + '<div class="card-address">' + (p.address||'Address TBC') + '</div>'
      + '<div class="card-location">' + [p.town, p.postcode].filter(Boolean).join(' Â· ') + '</div>'
      + '<div class="card-price">' + priceHtml + '</div>'
      + '</div>'
      + '<div class="card-body">'
      + '<div class="specs">' + specs + '</div>'
      + (tags ? '<div class="tags">' + tags + '</div>' : '')
      + school
      + (p.other ? '<div class="school-info" style="color:#555">âœ¨ ' + p.other + '</div>' : '')
      + (sourceBadges ? '<div style="margin-top:4px;display:flex;gap:4px;flex-wrap:wrap;">' + sourceBadges + '</div>' : '')
      + '</div>'
      + prosCons + notes
      + '<div class="card-footer">'
      + '<span class="status-badge ' + statusClass(p.status) + '">' + (p.status||'New') + '</span>'
      + '<span class="rating">' + stars(p.rating) + '</span>'
      + '<div class="links">' + linksHtml + planBtn + '</div>'
      + '</div>'
      + '</div>';
  }).join('');
}

// LIGHTBOX
function openLightbox(id, startIndex, mode) {
  var p = properties.find(function(x) { return x.id === id; });
  if (!p) return;
  lbCurrentId = id;
  lbMode = mode || 'photos';
  lbImages = lbMode === 'floorplan' ? (p.floorPlans||[]) : (p.photos||[]);
  if (!lbImages.length) return;
  lbIndex = startIndex || 0;
  var hasFP = p.floorPlans && p.floorPlans.length > 0;
  var tabsHtml = hasFP
    ? '<button class="lb-tab ' + (lbMode==='photos'?'active':'') + '" onclick="switchLbMode(\'photos\')" style="pointer-events:auto">ğŸ“· Photos (' + (p.photos||[]).length + ')</button>'
      + '<button class="lb-tab ' + (lbMode==='floorplan'?'active':'') + '" onclick="switchLbMode(\'floorplan\')" style="pointer-events:auto">ğŸ“ Floor Plan</button>'
    : '<button class="lb-tab active">ğŸ“· Photos (' + (p.photos||[]).length + ')</button>';
  document.getElementById('lb-tabs').innerHTML = tabsHtml;
  renderLightbox();
  document.getElementById('lightbox').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function switchLbMode(mode) {
  var p = properties.find(function(x) { return x.id === lbCurrentId; });
  if (!p) return;
  lbMode = mode;
  lbImages = mode === 'floorplan' ? (p.floorPlans||[]) : (p.photos||[]);
  lbIndex = 0;
  var tabs = document.querySelectorAll('.lb-tab');
  tabs.forEach(function(t, i) {
    t.classList.toggle('active', (i===0&&mode==='photos')||(i===1&&mode==='floorplan'));
  });
  renderLightbox();
}

function renderLightbox() {
  var lbEl = document.getElementById('lb-img');
  lbEl.referrerPolicy = 'no-referrer';
  lbEl.src = lbImages[lbIndex] || '';
  document.getElementById('lb-caption').textContent = (lbIndex+1) + ' / ' + lbImages.length;
  document.getElementById('lb-thumbs').innerHTML = lbImages.map(function(img, i) {
    return '<img class="lb-thumb ' + (i===lbIndex?'active':'') + '" src="' + img + '" referrerpolicy="no-referrer" onclick="lbIndex=' + i + ';renderLightbox()" loading="lazy">';
  }).join('');
}

function lbNav(dir) {
  lbIndex = (lbIndex + dir + lbImages.length) % lbImages.length;
  renderLightbox();
}

function closeLightbox() {
  document.getElementById('lightbox').classList.remove('open');
  document.body.style.overflow = '';
}

document.getElementById('lightbox').addEventListener('click', function(e) {
  if (e.target === this) closeLightbox();
});

document.addEventListener('keydown', function(e) {
  if (!document.getElementById('lightbox').classList.contains('open')) return;
  if (e.key === 'ArrowLeft') lbNav(-1);
  if (e.key === 'ArrowRight') lbNav(1);
  if (e.key === 'Escape') closeLightbox();
});

// â”€â”€ DETAIL SHEET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var detailId = null;
var detailStatus = 'New';
var detailRating = 0;

function openDetail(id) {
  var p = properties.find(function(x){ return x.id === id; });
  if (!p) return;
  detailId = id;
  detailStatus = p.status || 'New';
  detailRating = p.rating || 0;

  // Carousel
  var slides = [];
  (p.photos || []).forEach(function(img, i) {
    slides.push({ url: img, label: 'Photo ' + (i+1) + ' of ' + (p.photos||[]).length });
  });
  (p.floorPlans || []).forEach(function(img, i) {
    slides.push({ url: img, label: 'ğŸ“ Floor Plan' + (i > 0 ? ' '+(i+1) : '') });
  });
  var carousel = document.getElementById('ds-carousel');
  carousel.innerHTML = slides.map(function(s, i) {
    return '<div class="ds-slide"><img src="' + s.url + '" referrerpolicy="no-referrer" loading="' + (i<2?'eager':'lazy') + '" onerror="this.parentElement.style.display=\'none\'">'
      + '<div class="ds-slide-label">' + s.label + '</div></div>';
  }).join('') || '<div style="height:200px;background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:2rem;">ğŸ¡</div>';
  // Dots
  var dots = document.getElementById('ds-dots');
  dots.innerHTML = slides.length > 1 ? slides.map(function(_,i){ return '<div class="ds-dot' + (i===0?' active':'') + '"></div>'; }).join('') : '';
  carousel.onscroll = function() {
    var idx = Math.round(carousel.scrollLeft / carousel.offsetWidth);
    dots.querySelectorAll('.ds-dot').forEach(function(d,i){ d.classList.toggle('active', i===idx); });
  };

  // Hero
  document.getElementById('ds-price').innerHTML = fmt(p.askingPrice)
    + (p.priceReduced==='Yes' ? ' <span style="font-size:0.7rem;background:#ff6b35;color:white;padding:3px 8px;border-radius:6px;vertical-align:middle">REDUCED</span>' : '')
    + (isNewListing(p) ? ' <span style="font-size:0.7rem;background:#1a7340;color:white;padding:3px 8px;border-radius:6px;vertical-align:middle">NEW</span>' : '');
  document.getElementById('ds-address').textContent = p.address || 'Address TBC';
  document.getElementById('ds-location').textContent = [p.town, p.postcode].filter(Boolean).join(' Â· ');

  // Section A â€” specs
  var specs = '';
  if (p.beds) specs += '<div class="ds-spec">ğŸ› <strong>' + p.beds + '</strong><span>beds</span></div>';
  if (p.baths) specs += '<div class="ds-spec">ğŸš¿ <strong>' + p.baths + '</strong><span>baths</span></div>';
  if (p.receptions) specs += '<div class="ds-spec">ğŸ›‹ <strong>' + p.receptions + '</strong><span>recep</span></div>';
  if (p.propType) specs += '<div class="ds-spec">ğŸ  ' + p.propType + '</div>';
  if (p.tenure) specs += '<div class="ds-spec">ğŸ“‹ ' + p.tenure + '</div>';
  document.getElementById('ds-specs').innerHTML = specs;

  var tags = '';
  [['garden','Garden'],['driveway','Driveway'],['garage','Garage'],['outbuildings','Outbuildings']].forEach(function(pair) {
    var val = p[pair[0]];
    if (val==='Yes') tags += '<span class="ds-tag-yes">âœ“ ' + pair[1] + '</span>';
    else if (val==='No') tags += '<span class="ds-tag-no">âœ— ' + pair[1] + '</span>';
  });
  if (p.other) tags += '<span class="ds-tag-neu">âœ¨ ' + p.other + '</span>';
  document.getElementById('ds-tags').innerHTML = tags;

  var summary = p.summary || '';
  document.getElementById('ds-summary').textContent = summary ? (summary.length > 200 ? summary.slice(0,200) + 'â€¦' : summary) : '';
  document.getElementById('ds-agent').textContent = p.agent ? 'ğŸ¢ ' + p.agent : '';
  document.getElementById('ds-sources').innerHTML = getSourceBadges(p);

  // Section B â€” location
  var locHtml = '';
  if (p.distMiles) locHtml += '<div class="ds-school-row"><div class="ds-school-name">ğŸ“ ' + p.distMiles + ' miles from Cheltenham centre</div></div>';
  if (p.rural) locHtml += '<div class="ds-school-row"><div class="ds-school-name">ğŸŒ„ ' + p.rural + '</div></div>';
  if (p.address || p.town) {
    var mapQ = encodeURIComponent([p.address, p.town, p.postcode].filter(Boolean).join(', '));
    locHtml += '<a href="https://maps.google.com/?q=' + mapQ + '" target="_blank" style="display:inline-flex;align-items:center;gap:6px;margin-top:6px;font-size:0.85rem;color:#166534;font-weight:600;text-decoration:none;">ğŸ—º Open in Google Maps â†—</a>';
  }
  document.getElementById('ds-location-body').innerHTML = locHtml || '<div style="color:#aaa;font-size:0.82rem">Location details not available</div>';

  // Section C â€” schools
  var schoolHtml = buildSchoolsHTML(p);
  document.getElementById('ds-schools').innerHTML = schoolHtml;

  // Section D â€” your take
  renderStatusPills(detailStatus);
  renderStars(detailRating);
  document.getElementById('ds-view-date').value = p.viewDate || '';
  document.getElementById('ds-pros').value = p.pros || '';
  document.getElementById('ds-cons').value = p.cons || '';
  document.getElementById('ds-notes').value = p.notes || '';

  // Section E â€” links
  var linksHtml = '';
  var all = p.allLinks || {};
  var labelMap = { rightmove:'ğŸ”´ Rightmove', onthemarket:'ğŸŸ¢ OnTheMarket', zoopla:'ğŸŸ£ Zoopla' };
  var rmUrl = all.rightmove || p.rmLink;
  var otmUrl = all.onthemarket || p.otmLink;
  var zpUrl = p.zpLink;
  [[rmUrl,'ğŸ”´ Rightmove'],[otmUrl,'ğŸŸ¢ OnTheMarket'],[zpUrl,'ğŸŸ£ Zoopla']].forEach(function(pair){
    if (pair[0]) linksHtml += '<a href="' + pair[0] + '" target="_blank" class="ds-link-btn">' + pair[1] + '<span class="ds-link-chevron">â†—</span></a>';
  });
  var portalKeys = new Set(['rightmove','onthemarket','zoopla']);
  Object.keys(all).forEach(function(k){
    if (!portalKeys.has(k) && all[k]) linksHtml += '<a href="' + all[k] + '" target="_blank" class="ds-link-btn">ğŸ  ' + k + '<span class="ds-link-chevron">â†—</span></a>';
  });
  if (!Object.keys(all).length && p.agentLink) linksHtml += '<a href="' + p.agentLink + '" target="_blank" class="ds-link-btn">ğŸ  ' + (p.agent||'Agent site') + '<span class="ds-link-chevron">â†—</span></a>';
  document.getElementById('ds-links').innerHTML = linksHtml || '<div style="color:#aaa;font-size:0.82rem">No listing links available</div>';

  document.getElementById('ds-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function buildSchoolsHTML(p) {
  // OSM enriched data first
  var html = '';
  if (p.nearestPrimary && p.nearestPrimary.name) {
    var np = p.nearestPrimary;
    html += '<div class="ds-school-row"><div class="ds-school-name">ğŸ« ' + np.name + '</div>'
      + '<div class="ds-school-meta">Primary' + (np.distance?' Â· '+np.distance+'mi':'') + (np.ofsted?' Â· <span class="ds-ofsted-'+ofstedCls(np.ofsted)+'">Ofsted: '+np.ofsted+'</span>':'') + '</div></div>';
  }
  if (p.nearestSecondary && p.nearestSecondary.name) {
    var ns = p.nearestSecondary;
    html += '<div class="ds-school-row"><div class="ds-school-name">ğŸ“ ' + ns.name + '</div>'
      + '<div class="ds-school-meta">Secondary' + (ns.distance?' Â· '+ns.distance+'mi':'') + (ns.ofsted?' Â· <span class="ds-ofsted-'+ofstedCls(ns.ofsted)+'">Ofsted: '+ns.ofsted+'</span>':'') + '</div></div>';
  }
  if (html) return html;
  // Catchment fallback
  var pc = (p.postcode||'').toUpperCase().replace(/\s/g,'');
  var sector = pc.slice(0,5), district = pc.slice(0,4);
  var pri = CATCHMENT_PRI[sector] || DISTRICT_PRI[district];
  var sec = CATCHMENT_SEC[sector] || DISTRICT_SEC[district];
  var approx = !CATCHMENT_PRI[sector] && pri;
  if (pri) html += '<div class="ds-school-row"><div class="ds-school-name">ğŸ« ' + pri + (approx?' <span style="color:#ccc;font-size:0.72rem">(approx)</span>':'') + '</div>'
    + '<div class="ds-school-meta">Primary' + (OFSTED_PRI[pri]?' Â· <span class="ds-ofsted-'+ofstedCls(OFSTED_PRI[pri])+'">Ofsted: '+OFSTED_PRI[pri]+'</span>':'') + '</div></div>';
  if (sec) html += '<div class="ds-school-row"><div class="ds-school-name">ğŸ“ ' + sec + (approx?' <span style="color:#ccc;font-size:0.72rem">(approx)</span>':'') + '</div>'
    + '<div class="ds-school-meta">Secondary' + (OFSTED_SEC[sec]?' Â· <span class="ds-ofsted-'+ofstedCls(OFSTED_SEC[sec])+'">Ofsted: '+OFSTED_SEC[sec]+'</span>':'') + '</div></div>';
  if (!html && p.postcode) html = '<div style="color:#888;font-size:0.83rem">ğŸ“ <a href="https://www.gloucestershire.gov.uk/education-and-learning/schools-and-admissions/school-admissions/find-your-catchment-area-school/?postcode=' + encodeURIComponent(p.postcode) + '" target="_blank" style="color:#6B21A8">Check catchment for ' + p.postcode + ' â†—</a></div>';
  return html || '<div style="color:#aaa;font-size:0.82rem">No school data available</div>';
}

function ofstedCls(o) {
  if (o==='Outstanding') return 'out';
  if (o==='Good') return 'good';
  return 'ri';
}

function renderStatusPills(active) {
  document.querySelectorAll('.ds-pill').forEach(function(btn) {
    var map = {'New':'new','Viewing Booked':'viewing','Viewed':'viewed','Interested':'interested','Offer Made':'offer','Rejected':'rejected'};
    var status = Object.keys(map).find(function(k){ return map[k] === btn.className.split('ds-pill-')[1]; });
    btn.classList.toggle('active', btn.textContent.trim().toLowerCase().replace(' ','') === active.toLowerCase().replace(' ','') || btn.className.includes('ds-pill-' + (active==='Viewing Booked'?'viewing':active==='Offer Made'?'offer':active.toLowerCase())));
  });
}

function setStatus(s) {
  detailStatus = s;
  document.querySelectorAll('.ds-pill').forEach(function(btn){
    var cls = btn.classList[1];
    var match = (s==='New'&&cls==='ds-pill-new')||(s==='Viewing Booked'&&cls==='ds-pill-viewing')
      ||(s==='Viewed'&&cls==='ds-pill-viewed')||(s==='Interested'&&cls==='ds-pill-interested')
      ||(s==='Offer Made'&&cls==='ds-pill-offer')||(s==='Rejected'&&cls==='ds-pill-rejected');
    btn.classList.toggle('active', match);
  });
}

function renderStars(n) {
  document.querySelectorAll('.ds-star').forEach(function(s, i) {
    s.textContent = i < n ? 'â­' : 'â˜†';
  });
}

function setRating(n) {
  detailRating = detailRating === n ? 0 : n;
  renderStars(detailRating);
}

function saveAssessment() {
  if (!detailId) return;
  var idx = properties.findIndex(function(x){ return x.id === detailId; });
  if (idx < 0) return;
  properties[idx].status = detailStatus;
  properties[idx].rating = detailRating || null;
  properties[idx].viewDate = document.getElementById('ds-view-date').value;
  properties[idx].pros = document.getElementById('ds-pros').value;
  properties[idx].cons = document.getElementById('ds-cons').value;
  properties[idx].notes = document.getElementById('ds-notes').value;
  // Persist assessment in localStorage (keyed by property id)
  var assessments = JSON.parse(localStorage.getItem('assessments-v1') || '{}');
  assessments[detailId] = { status: properties[idx].status, rating: properties[idx].rating,
    viewDate: properties[idx].viewDate, pros: properties[idx].pros,
    cons: properties[idx].cons, notes: properties[idx].notes };
  localStorage.setItem('assessments-v1', JSON.stringify(assessments));
  closeDetail();
  render();
}

function closeDetail() {
  document.getElementById('ds-overlay').classList.remove('open');
  document.body.style.overflow = '';
}

function openEditFromDetail() {
  closeDetail();
  openModal(detailId);
}

// â”€â”€ ADD/EDIT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(id) {
  editingId = id || null;
  var p = id ? (properties.find(function(x){return x.id===id;}) || {}) : {};
  document.getElementById('modal-title').textContent = id ? 'Edit Property' : 'Add Property';
  document.getElementById('btn-delete').style.display = id ? 'block' : 'none';
  var flds = {
    'f-address':p.address||'','f-town':p.town||'','f-postcode':p.postcode||'',
    'f-asking-price':p.askingPrice||'','f-price-reduced':p.priceReduced||'No',
    'f-beds-count':p.beds||'','f-baths-count':p.baths||'','f-receptions':p.receptions||'',
    'f-prop-type':p.propType||'Detached','f-tenure':p.tenure||'Freehold','f-new-build':p.newBuild||'No',
    'f-garden-yn':p.garden||'Yes','f-garden-size':p.gardenSize||'',
    'f-out-yn':p.outbuildings||'No','f-out-detail':p.outbuildingDetail||'',
    'f-drive':p.driveway||'Yes','f-garage':p.garage||'No',
    'f-other':p.other||'','f-distance':p.distance||'','f-rural':p.rural||'Village',
    'f-agent':p.agent||'','f-date-listed':p.dateListed||'',
    'f-rm-link':p.rmLink||'','f-zp-link':p.zpLink||'','f-otm-link':p.otmLink||'',
    'f-stat':p.status||'New','f-view-date':p.viewDate||'','f-our-rating':p.rating||'',
    'f-pros':p.pros||'','f-cons':p.cons||'','f-notes':p.notes||''
  };
  Object.keys(flds).forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.value = flds[id];
  });
  // Show agent-direct links from allLinks
  var allLinks = p.allLinks || {};
  var portalKeys = new Set(['rightmove','onthemarket','zoopla']);
  var agentEntries = Object.keys(allLinks).filter(function(k){ return !portalKeys.has(k) && allLinks[k]; });
  var agentLinksWrap = document.getElementById('modal-agent-links-wrap');
  var agentLinksDiv = document.getElementById('modal-agent-links');
  if (agentEntries.length) {
    agentLinksDiv.innerHTML = agentEntries.map(function(k) {
      return '<a href="' + allLinks[k] + '" target="_blank" style="padding:5px 10px;border:1px solid #ddd;border-radius:6px;text-decoration:none;color:#2c2c2c;">' + k + ' â†—</a>';
    }).join('');
    agentLinksWrap.style.display = '';
  } else if (p.agentLink) {
    agentLinksDiv.innerHTML = '<a href="' + p.agentLink + '" target="_blank" style="padding:5px 10px;border:1px solid #ddd;border-radius:6px;text-decoration:none;color:#2c2c2c;">' + (p.agent||'Agent') + ' â†—</a>';
    agentLinksWrap.style.display = '';
  } else {
    agentLinksWrap.style.display = 'none';
  }
  // Show sources
  var sourceStr = (p.sources||[p.source||'']).filter(Boolean).join(', ');
  var sourceWrap = document.getElementById('modal-sources');
  if (sourceWrap) sourceWrap.textContent = sourceStr ? 'Listed on: ' + sourceStr : '';
  document.getElementById('modal').classList.add('open');
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
  editingId = null;
}

function saveProperty() {
  var p = {
    id: editingId || Date.now().toString(),
    address: document.getElementById('f-address').value,
    town: document.getElementById('f-town').value,
    postcode: document.getElementById('f-postcode').value,
    askingPrice: parseFloat(document.getElementById('f-asking-price').value)||null,
    priceReduced: document.getElementById('f-price-reduced').value,
    beds: parseInt(document.getElementById('f-beds-count').value)||null,
    baths: parseInt(document.getElementById('f-baths-count').value)||null,
    receptions: parseInt(document.getElementById('f-receptions').value)||null,
    propType: document.getElementById('f-prop-type').value,
    tenure: document.getElementById('f-tenure').value,
    newBuild: document.getElementById('f-new-build').value,
    garden: document.getElementById('f-garden-yn').value,
    gardenSize: document.getElementById('f-garden-size').value,
    outbuildings: document.getElementById('f-out-yn').value,
    outbuildingDetail: document.getElementById('f-out-detail').value,
    driveway: document.getElementById('f-drive').value,
    garage: document.getElementById('f-garage').value,
    other: document.getElementById('f-other').value,
    distance: parseFloat(document.getElementById('f-distance').value)||null,
    rural: document.getElementById('f-rural').value,
    agent: document.getElementById('f-agent').value,
    dateListed: document.getElementById('f-date-listed').value,
    rmLink: document.getElementById('f-rm-link').value,
    zpLink: document.getElementById('f-zp-link').value,
    otmLink: document.getElementById('f-otm-link').value,
    status: document.getElementById('f-stat').value,
    viewDate: document.getElementById('f-view-date').value,
    rating: parseInt(document.getElementById('f-our-rating').value)||null,
    pros: document.getElementById('f-pros').value,
    cons: document.getElementById('f-cons').value,
    notes: document.getElementById('f-notes').value,
    source: 'local'
  };
  if (editingId) {
    var idx = properties.findIndex(function(x){return x.id===editingId;});
    if (idx >= 0) properties[idx] = p;
  } else {
    properties.push(p);
  }
  var localProps = properties.filter(function(x){return x.source==='local'||!x.source;});
  localStorage.setItem('house-search-v1', JSON.stringify(localProps));
  closeModal();
  render();
}

function deleteProperty() {
  if (!editingId || !confirm('Delete this property?')) return;
  properties = properties.filter(function(x){return x.id!==editingId;});
  var localProps = properties.filter(function(x){return x.source==='local'||!x.source;});
  localStorage.setItem('house-search-v1', JSON.stringify(localProps));
  closeModal();
  render();
}

function resetFilters() {
  document.getElementById('f-price').value = 1200000;
  document.getElementById('price-display').textContent = 'Up to Â£1,200,000';
  document.getElementById('f-radius').value = 8;
  document.getElementById('radius-display').textContent = 'Within 8 miles';
  ['f-beds','f-baths','f-type','f-garden','f-outbuildings','f-school','f-sec-school','f-status','f-sort'].forEach(function(id){
    var el = document.getElementById(id);
    if (el) el.value = id==='f-beds'?'4':id==='f-sort'?'price-desc':'';
  });
  document.getElementById('f-beds').value = '4';
  document.getElementById('f-rating').value = '0';
  document.getElementById('f-sort').value = 'price-desc';
  render();
}

document.getElementById('f-price').addEventListener('input', function() {
  document.getElementById('price-display').textContent = 'Up to Â£' + Number(this.value).toLocaleString('en-GB');
  render();
});
document.getElementById('f-radius').addEventListener('input', function() {
  document.getElementById('radius-display').textContent = 'Within ' + this.value + ' miles';
  render();
});
['f-beds','f-baths','f-type','f-garden','f-outbuildings','f-school','f-sec-school','f-status','f-rating','f-sort'].forEach(function(id) {
  var el = document.getElementById(id);
  if (el) el.addEventListener('change', render);
});
document.getElementById('modal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    if (document.getElementById('lightbox').classList.contains('open')) closeLightbox();
    else if (document.getElementById('modal').classList.contains('open')) closeModal();
  }
});

// INIT - load remote properties.json then render
(async function() {
  try {
    var resp = await fetch('properties.json?t=' + Date.now());
    if (resp.ok) {
      var remote = await resp.json();
      var local = JSON.parse(localStorage.getItem('house-search-v1') || '[]');
      var localIds = new Set(local.map(function(p){return p.id;}));
      properties = remote.filter(function(p){return !localIds.has(p.id);}).concat(local);
      // Overlay saved assessments onto remote properties
      var assessments = JSON.parse(localStorage.getItem('assessments-v1') || '{}');
      properties.forEach(function(p) {
        if (assessments[p.id]) Object.assign(p, assessments[p.id]);
      });
      var dates = remote.map(function(p){return p.lastUpdated;}).filter(Boolean).sort();
      if (dates.length) {
        var el = document.getElementById('remote-updated');
        if (el) el.textContent = 'Updated ' + dates[dates.length-1];
      }
    }
  } catch(e) {
    properties = JSON.parse(localStorage.getItem('house-search-v1') || '[]');
  }
  render();
})();
</script>
</body>
</html>
